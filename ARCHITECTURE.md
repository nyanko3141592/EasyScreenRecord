# EasyScreenRecord アーキテクチャ

このドキュメントでは、EasyScreenRecord のシステム設計とコンポーネント構成について説明します。

## 概要

EasyScreenRecord は、macOS 向けのスマートズーム機能付き画面録画アプリケーションです。MVVM (Model-View-ViewModel) パターンを採用し、SwiftUI と ScreenCaptureKit を活用した構成になっています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Application Layer                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  EasyScreenRecordApp.swift                                  │ │
│  │  - MenuBarExtra (メニューバーUI)                            │ │
│  │  - グローバルショートカット管理                              │ │
│  │  - 設定ウィンドウ                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          View Layer                              │
│  ┌───────────────────┐  ┌────────────────────────────────────┐  │
│  │   ContentView     │  │     RegionSelectorView             │  │
│  │   - メインUI      │  │     - 範囲選択オーバーレイ         │  │
│  │   - 録画コントロール│  │     - ドラッグ&リサイズ            │  │
│  └───────────────────┘  └────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  RecordingOverlayView                                      │  │
│  │  - ズームインジケーター表示                                 │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       ViewModel Layer                            │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  RecorderViewModel                                          │ │
│  │  - SwiftUI と Model の橋渡し                                │ │
│  │  - 範囲選択ロジック                                         │ │
│  │  - UI状態管理 (isRecording, isBusy)                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Model Layer                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  ScreenRecorder                                              │ │
│  │  - 録画ステートマシン                                        │ │
│  │  - SCStream 管理                                             │ │
│  │  - AVAssetWriter によるエンコード                            │ │
│  │  - スマートズームロジック                                    │ │
│  │  - ウィンドウ管理 (オーバーレイ/ディミング)                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────┐  ┌────────────────────────────────────┐  │
│  │  ZoomSettings     │  │  AccessibilityUtils                │  │
│  │  - ズーム設定     │  │  - カーソル位置検出                │  │
│  │  - プリセット管理  │  │  - Accessibility API 連携          │  │
│  └───────────────────┘  └────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      System Frameworks                           │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────────┐ │
│  │ScreenCapture │ │ AVFoundation │ │ Accessibility Framework  │ │
│  │    Kit       │ │              │ │       (AXUIElement)      │ │
│  └──────────────┘ └──────────────┘ └──────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. ScreenRecorder (Model)

録画エンジンのコアコンポーネントです。

#### ステートマシン

```
     ┌─────────────────────────────────────────────────┐
     │                                                 │
     ▼                                                 │
  ┌──────┐  startRecording()   ┌──────────┐           │
  │ idle │ ─────────────────▶  │ starting │           │
  └──────┘                     └──────────┘           │
     ▲                              │                  │
     │                              │ 初期化完了        │
     │                              ▼                  │
     │                        ┌───────────┐           │
     │       stopRecording()  │ recording │ ──────────┘
     │  ◀──────────────────── └───────────┘   エラー発生
     │                              │
     │                              │ stopRecording()
     │                              ▼
     │                        ┌──────────┐
     └─────────────────────── │ stopping │
           完了               └──────────┘
```

#### 主要な責務

| 機能 | 説明 |
|------|------|
| **録画制御** | `startRecording()`, `stopRecording()` による録画ライフサイクル管理 |
| **ストリーム処理** | ScreenCaptureKit の `SCStream` を使用した画面キャプチャ |
| **エンコード** | AVAssetWriter による H.264/MOV 形式でのビデオ書き込み |
| **ズーム処理** | カーソル追従とスムーズなズームイン/アウト |
| **ウィンドウ管理** | オーバーレイウィンドウとディミングウィンドウの制御 |

#### スレッド安全性

- `writingQueue`: AVAssetWriter への書き込み専用シリアルキュー
- すべてのバッファ操作は専用キューで実行
- 状態遷移時の競合を防止

### 2. RecorderViewModel (ViewModel)

SwiftUI の View と ScreenRecorder Model を橋渡しするコンポーネントです。

```swift
class RecorderViewModel: ObservableObject {
    @Published var isRecording: Bool
    @Published var isBusy: Bool
    @Published var selectedRegion: CGRect?

    private let recorder: ScreenRecorder
}
```

#### 責務

- UI 状態の管理と公開
- 範囲選択ウィンドウの表示制御
- Model のメソッド呼び出しの中継

### 3. ZoomSettings (Model)

ズーム機能の設定を管理するモデルです。

#### ズームモード

| モード | 説明 |
|--------|------|
| **Scale-based** | 倍率指定 (2x, 3x など) |
| **Frame-based** | 固定フレームサイズ (800x600 など) |

#### プリセット

| プリセット | スムージング | 用途 |
|------------|--------------|------|
| **滑らか** | 高 | デモ・プレゼンテーション |
| **標準** | 中 | 一般的な使用 |
| **高速** | 低 | クイックチュートリアル |

### 4. AccessibilityUtils (Model)

Accessibility API を使用したカーソル位置検出を担当します。

#### 主要機能

- フォーカス中のテキストフィールド検出
- カーソル位置の取得
- アプリケーション間での追従

#### 座標系変換

```
NSWindow座標系 (グローバル)
        │
        ▼
ディスプレイローカル座標系
        │
        ▼
スクリーンローカル座標系 (録画範囲内)
```

## データフロー

### 録画開始フロー

```
1. User Action (Start Recording)
         │
         ▼
2. RecorderViewModel.startRecording()
         │
         ▼
3. ScreenRecorder.startRecording()
         │
         ├──▶ 状態を .starting に変更
         │
         ├──▶ SCStream を初期化
         │
         ├──▶ AVAssetWriter を初期化
         │
         ├──▶ オーバーレイウィンドウを表示
         │
         └──▶ 状態を .recording に変更
         │
         ▼
4. フレーム受信ループ開始
   SCStreamDelegate → writingQueue → AVAssetWriter
```

### スマートズームフロー

```
1. タイピング検出 (AccessibilityUtils)
         │
         ▼
2. カーソル位置取得
         │
         ▼
3. ズーム目標計算
   ├── タイピング中: zoomScale (e.g., 2.0x)
   └── アイドル時: 1.0x (フルビュー)
         │
         ▼
4. スムーズ補間 (lerp)
   - 位置のスムージング
   - スケールのスムージング
         │
         ▼
5. フレームにズーム適用
```

## ファイル構成

```
EasyScreenRecord/
├── EasyScreenRecord/
│   ├── Models/
│   │   ├── ScreenRecorder.swift      # 録画エンジン (1,092行)
│   │   ├── ZoomSettings.swift        # ズーム設定モデル
│   │   └── AccessibilityUtils.swift  # カーソル検出ユーティリティ
│   │
│   ├── ViewModels/
│   │   └── RecorderViewModel.swift   # SwiftUI-Model ブリッジ
│   │
│   ├── Views/
│   │   ├── EasyScreenRecordApp.swift # アプリエントリポイント
│   │   ├── ContentView.swift         # メインUI
│   │   ├── RegionSelectorView.swift  # 範囲選択UI (629行)
│   │   └── RecordingOverlayView.swift # ズームインジケーター
│   │
│   └── Assets.xcassets/              # アイコン・カラー
│
├── run.sh                            # 開発用ビルドスクリプト
└── build-dmg.sh                      # リリース用DMG作成スクリプト
```

## 依存フレームワーク

| フレームワーク | 用途 |
|---------------|------|
| **SwiftUI** | UI構築 |
| **AppKit** | NSWindow管理、メニューバー |
| **ScreenCaptureKit** | 画面キャプチャ |
| **AVFoundation** | ビデオエンコード |
| **Accessibility** | カーソル位置検出 |
| **Combine** | 状態管理・リアクティブプログラミング |

## 設計原則

1. **MVVM パターン**: View と Model の疎結合
2. **シリアルキューによるスレッド安全性**: 録画処理の競合防止
3. **ステートマシン**: 明確な状態遷移による安定性
4. **Combine**: リアクティブな状態管理

## セキュリティ考慮事項

- **画面収録権限**: ScreenCaptureKit 使用に必須
- **アクセシビリティ権限**: カーソル位置検出に必須
- **権限未付与時**: UI でグレースフルに警告表示
